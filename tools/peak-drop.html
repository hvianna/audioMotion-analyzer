<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<link href="styles.css" rel="stylesheet">
	<title>Peak drop equation analysis | audioMotion-analyzer</title>
</head>
<body>
	<div class="container">
		<div>
			<h1>audioMotion-analyzer</h1>
			<h2>peak drop equation analysis</h2>
			<canvas id="canvas" width="400" height="400"></canvas>
			<div id="legend"></div>
			<div class="note">Click labels to show / hide the corresponding curves</div>
			<div class="grid grid-6-cols">
				<div>Time range (ms):</div><div><input id="time-range" type="number" min="500" max="5000" step="50" value="1000"></div>
				<div><span class="bullet round color-black"></span><span class="bullet round half color-blue"></span>Frame rate (fps):</div><div><input id="frame-rate" type="number" min="10" max="240" step="1" value="60"></div>
				<div><span class="bullet round color-purple"></span>peakDecayTime (ms):</div><div class="self-right"><input id="user-peakdecaytime" type="number" min="0" max="5000" step="50" value="1000" placeholder="default: 750"></div>
				<div><span class="bullet round color-black"></span><span class="bullet round half color-red"></span>Analyzer height (px):</div><div><input id="canvas-height" type="number" min="270" max="2160" step="1" value="1080"></div>
				<div><span class="bullet round color-red"></span>gravity (kpx/sÂ²):</div><div><input id="user-gravity" type="number" min=".1" max="30" step=".1" value="3.8" placeholder="default: 3.8"></div>
				<button class="colspan-2">Refresh</button>
			</div>
			<p></p>
			<div class="note margin-top">
				<table>
					<tr><th>version</th><th>peak acceleration</th><th>decay time from max to zero</th></tr>
					<tr><td><span class="bullet round color-black"></span>v1.0.0</td><td>varies with frame rate</td><td>depends on frame rate and analyzer height</td></tr>
					<tr><td><span class="bullet round color-blue"></span>v3.5.0</td><td>varies with frame rate</td><td>depends on frame rate</td></tr>
					<tr><td><span class="bullet round color-yellow"></span>v4.2.0</td><td>adjusts to analyzer height</td><td>constant</td></tr>
					<tr><td><span class="bullet round color-red"></span>v4.5.0</td><td>customizable</td><td>depends on analyzer height</td></tr>
					<tr><td><span class="bullet round color-green"></span>v5.0.0</td><td>adjusts to analyzer height</td><td>customizable <span class="bullet round color-purple"></span></td></tr>
				</table>
			</div>
			<p class="credits absolute-center">
				<strong>audioMotion-analyzer</strong> Copyright &copy; 2018-2026 Henrique Avila Vianna.<br>
				Licensed under AGPL-3.0 or later. Source code is available on <a href="https://github.com/hvianna/audioMotion-analyzer">GitHub</a>.
			</p>
		</div>
	</div>

<script>
const canvas = document.getElementById('canvas'),
	  legend = document.getElementById('legend'),
	  ctx    = canvas.getContext('2d'),
	  colors = [ '#000000', '#039aff', '#ffd800', '#ff3500', '#00aa2e', '#c200ff' ],
	  labels = [
			{ val: 'v100', text: 'v1.0.0' },
		  	{ val: 'v350', text: 'v3.5.0' },
		  	{ val: 'v420', text: 'v4.2.0' },
			{ val: 'v450', text: 'v4.5.0 (gravity: <span id="label-gravity"></span>)' },
			{ val: 'v500', text: 'v5.0.0 (default)' },
			{ val: 'user', text: 'peakDecayTime: <span id="label-peakdecaytime"></span>' }
	  ];

function buildGraph() {

	const GRAPH_BORDER = 50,
		  GRAPH_HEIGHT = 400,
		  GRAPH_WIDTH  = 800;

	// peak decay emulation settings

	const canvasHeight       = +document.getElementById('canvas-height').value,
		  frameRate          = +document.getElementById('frame-rate').value,
		  rangeX             = +document.getElementById('time-range').value,
		  DEFAULT_GRAVITY    = 3.8,
		  DEFAULT_DECAY_TIME = 750;

	// This function simulates peak drop - `hold` is bar.hold[ channel ] in the `_draw()` method
	// Returns an array of peak value for each frame

	const drop = ( callback, peakValue, customParameter ) => {
		let ret = [ peakValue ];
		// hold decreases by 1 on every animation frame and peak decay starts when hold < 0
		for ( let hold = -1; peakValue > 0 && hold > frameRate * ( rangeX / -1e3 - 1 ); hold-- ) {
			peakValue += callback( hold, customParameter );
			ret.push( peakValue );
		}
		return ret;
	}

	// callbacks provide the decay equations used in different versions of audioMotion-analyzer

	const callbacks = {
		// v5.0.0
		// computes required acceleration to meet the requested decay time (default 750ms)
		v500: ( hold, peakDecayTime ) => hold * 2 / peakDecayTime ** 2 / frameRate ** 2,

		// v4.5.0
		// 1 to 0 in ~750ms using default gravity and canvas height = 1080px
		v450: ( hold, gravity ) => ( hold * gravity * 1e3 / frameRate ** 2 ) / canvasHeight,

		// v4.2.0 to 4.4.0
		// 1 to 0 in ~500ms - frame rate independent
		v420: hold => {
			const holdFrames = frameRate >> 1;
			return hold / ( holdFrames * holdFrames / 2 );
		},

		// v3.5.0 to 4.1.1 (peak value normalized [0;1])
		// 1 to 0 in ~45 frames (~750ms @60fps)
		v350: hold => hold / 1080,

		// v1.0.0 to 3.4.0 (peak value in pixels)
		// 1080 to 0 in 45 frames (750ms @60fps)
		v100: hold => hold - 1
	}

	// generate graph

	const maxX   = GRAPH_WIDTH - GRAPH_BORDER,
		  minX   = GRAPH_BORDER,
		  maxY   = GRAPH_HEIGHT - GRAPH_BORDER,
		  minY   = GRAPH_BORDER,
		  rangeY = 1,
		  graphX = val => minX + ( maxX - minX ) / rangeX * val,
		  graphY = val => maxY - ( maxY - minY ) / rangeY * val;

	const userGravity = +document.getElementById('user-gravity').value || DEFAULT_GRAVITY;
	document.getElementById('label-gravity').innerText = userGravity; // update graph label with custom gravity

	const userPeakDecayTime = +document.getElementById('user-peakdecaytime').value || DEFAULT_DECAY_TIME;
	document.getElementById('label-peakdecaytime').innerText = userPeakDecayTime;

	canvas.width  = GRAPH_WIDTH;
	canvas.height = GRAPH_HEIGHT;

	ctx.lineWidth = 2;
	ctx.moveTo( minX - 1, minY - 1 );
	ctx.lineTo( minX - 1, maxY + 1 );
	ctx.lineTo( maxX + 1, maxY + 1 );
	ctx.stroke();

	ctx.lineWidth = 1.5;
	ctx.strokeStyle = '#ccc';
	ctx.font = '14px sans-serif';

	ctx.textAlign = 'right';
	ctx.beginPath();
	for ( let valY = 1; valY >= 0; valY -= .25 ) {
		const y = graphY( valY ) | 0;
		ctx.fillText( valY, minX - 7, y + 5 );
		if ( valY > 0 ) {
			ctx.moveTo( minX, y );
			ctx.lineTo( maxX, y );
		}
	}

	ctx.textAlign = 'center';
	ctx.fillText( 'Time (ms)', canvas.width / 2, canvas.height - 5 );

	ctx.save();
	ctx.rotate( -Math.PI / 2 );
	ctx.fillText( 'Peak value', -canvas.height / 2, 10 );
	ctx.restore();

	for ( let valX = 0; valX <= rangeX; valX += rangeX / 10 ) {
		const x = graphX( valX );
		if ( valX % ( rangeX / 10 ) == 0 )
			ctx.fillText( valX, x, maxY + 20 );
		if ( valX > 0 ) {
			ctx.moveTo( x, minY );
			ctx.lineTo( x, maxY );
		}
	}
	ctx.stroke();

	// plot curves

	ctx.lineWidth = 2.5;
	for ( let i = 0; i < labels.length; i++ ) {
		const label = labels[ i ].val;
		if ( document.getElementById(`label-${ label }`).checked ) {
			ctx.beginPath();
			ctx.strokeStyle = colors[ i ] + 'cc';

			const peakValue       = label == 'v100' ? canvasHeight : 1,
				  customParameter = label == 'v450' ? userGravity : ( label == 'user' ? userPeakDecayTime : DEFAULT_DECAY_TIME ) / 1e3,
				  data            = drop( callbacks[ label == 'user' ? 'v500' : label ], peakValue, customParameter );

			for ( const [ index, val ] of data.entries() ) {
				const method = index == 0 ? 'moveTo' : 'lineTo',
					  time   = index / frameRate * 1000;
				ctx[ method ]( graphX( time ), graphY( val / ( label == 'v100' ? canvasHeight : 1 ) ) );
			}
			ctx.stroke();
		}
	}

}

/* main */

for ( let i = 0; i < labels.length; i++ )
	legend.innerHTML += `<label class="labelSelector"><input type="checkbox" id="label-${ labels[ i ].val }" checked> ` +
						`<span class="bullet" style="background: ${ colors[ i ] }"></span> ${ labels[ i ].text }</label>`;

for ( const el of document.querySelectorAll('input[id^="label-"]') )
	el.addEventListener( 'click', () => buildGraph() );

for ( const el of document.querySelectorAll('input[type="number"]') )
	el.addEventListener( 'change', () => buildGraph() );

buildGraph();

</script>

</body>
</html>
